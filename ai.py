"""AI engine ‚Äî OpenAI Agents SDK. –í—Å—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –≤ –ø—Ä–æ–º–ø—Ç–µ, tools —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã."""

from __future__ import annotations

import asyncio
import base64
import json
import logging
from dataclasses import dataclass

from openai import AsyncOpenAI
from agents import (
    Agent,
    ModelSettings,
    Runner,
    RunContextWrapper,
    SQLiteSession,
    function_tool,
    handoff,
    trace,
)
from tenacity import retry, stop_after_attempt, wait_exponential

from config import (
    OPENAI_API_KEY,
    OPENAI_MODEL,
    OPENAI_TEMPERATURE,
    OPENAI_MAX_TOKENS,
    AGENT_MAX_TURNS,
    AGENT_SESSIONS_DB_PATH,
)
import db
import services
from greenapi_client import send_photos

logger = logging.getLogger(__name__)

# OpenAI client –¥–ª—è Whisper (Agents SDK –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç audio)
_openai_client = AsyncOpenAI(api_key=OPENAI_API_KEY)


# ‚îÄ‚îÄ Context ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@dataclass
class ChatContext:
    chat_id: str
    sender_name: str = ""


# ‚îÄ‚îÄ Tools ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# Lock per chat ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –¥—É–±–ª–µ–π —Ñ–æ—Ç–æ
_photo_locks: dict[str, asyncio.Lock] = {}


@function_tool
async def check_stock(
    ctx: RunContextWrapper[ChatContext],
    product: str,
    size: str = "",
    color: str = "",
) -> str:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ. –í—ã–∑–æ–≤–∏ –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞."""
    chat_id = ctx.context.chat_id
    logger.info(f"[{chat_id}] Tool: check_stock(product={product}, size={size}, color={color})")
    result = await services.check_stock(product, size, color)
    return json.dumps(result, ensure_ascii=False)


@function_tool
async def get_photos(
    ctx: RunContextWrapper[ChatContext],
    product: str,
    color: str = "",
) -> str:
    """–ù–∞–π—Ç–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –∫–ª–∏–µ–Ω—Ç—É. –í—ã–∑–æ–≤–∏ –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç '–ø–æ–∫–∞–∂–∏—Ç–µ', '–∫–∞–∫–∏–µ –µ—Å—Ç—å', –∏–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.
    –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–π –û–î–ò–ù —Ä–∞–∑ –Ω–∞ —Ç–æ–≤–∞—Ä, –ù–ï –≤—ã–∑—ã–≤–∞–π –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞ –∫–∞–∂–¥—ã–π —Ü–≤–µ—Ç ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–≤–µ—Ç–∞.
    –í–ê–ñ–ù–û: –í–°–ï–ì–î–ê –≤—ã–∑—ã–≤–∞–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–∞–Ω–µ–µ —Ñ–æ—Ç–æ –Ω–µ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã ‚Äî –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –∏ —Ñ–æ—Ç–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è."""
    chat_id = ctx.context.chat_id
    logger.info(f"[{chat_id}] Tool: get_photos(product={product}, color={color})")

    # Lock per chat ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö
    if chat_id not in _photo_locks:
        _photo_locks[chat_id] = asyncio.Lock()

    async with _photo_locks[chat_id]:
        photos = await services.find_photos(product, color)
        if not photos:
            return json.dumps({"sent": False, "reason": "–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"})

        # –§–∏–ª—å—Ç—Ä—É–µ–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –ø–æ file_id
        already_sent = await db.get_sent_photo_ids(chat_id)
        new_photos = [p for p in photos if p["file_id"] not in already_sent]

        if not new_photos:
            return json.dumps({"sent": False, "reason": "–§–æ—Ç–æ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –∫–ª–∏–µ–Ω—Ç—É"})

        await send_photos(chat_id, new_photos)
        await db.mark_photos_sent(chat_id, [p["file_id"] for p in new_photos])
        captions = [p["caption"] for p in new_photos if p.get("caption")]
        return json.dumps({"sent": True, "count": len(new_photos), "captions": captions}, ensure_ascii=False)


@function_tool
async def submit_order(
    ctx: RunContextWrapper[ChatContext],
    product: str,
    city: str,
    size: str = "",
    color: str = "",
    address: str = "",
) -> str:
    """–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑. –í—ã–∑–æ–≤–∏ –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ —Å–æ–±—Ä–∞–Ω—ã –í–°–ï –¥–∞–Ω–Ω—ã–µ: —Ç–æ–≤–∞—Ä, —Ä–∞–∑–º–µ—Ä (–¥–ª—è –æ–±—É–≤–∏), —Ü–≤–µ—Ç, –≥–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å. –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å."""
    chat_id = ctx.context.chat_id
    logger.info(f"[{chat_id}] Tool: submit_order(product={product}, city={city})")
    order = {
        "product": product,
        "size": size,
        "color": color,
        "city": city,
        "address": address,
        "client_phone": chat_id.replace("@c.us", ""),
    }
    await db.save_order_state(chat_id, order)
    await db.set_client_status(chat_id, "ordered")
    await services.notify_order(order)
    await services.notify_order_whatsapp(order)
    await services.send_order_to_n8n(order)
    return json.dumps({"success": True, "order": order}, ensure_ascii=False)


@function_tool
async def set_client_status(
    ctx: RunContextWrapper[ChatContext],
    status: str,
) -> str:
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∏–µ–Ω—Ç–∞. –í—ã–∑—ã–≤–∞–π –∫–æ–≥–¥–∞ —è—Å–Ω–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:
    - 'fitting' ‚Äî –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª —á—Ç–æ –ø—Ä–∏–µ–¥–µ—Ç –Ω–∞ –ø—Ä–∏–º–µ—Ä–∫—É –≤ –º–∞–≥–∞–∑–∏–Ω
    - 'declined' ‚Äî –∫–ª–∏–µ–Ω—Ç —á—ë—Ç–∫–æ –æ—Ç–∫–∞–∑–∞–ª—Å—è ("–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–Ω–µ –Ω–∞–¥–æ", "–æ—Ç–∫–∞–∂—É—Å—å")
    –ù–µ –≤—ã–∑—ã–≤–∞–π –¥–ª—è 'ordered' ‚Äî —ç—Ç–æ –¥–µ–ª–∞–µ—Ç submit_order –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    –ù–µ –≤—ã–∑—ã–≤–∞–π –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è –∏–ª–∏ –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã."""
    chat_id = ctx.context.chat_id
    logger.info(f"[{chat_id}] Tool: set_client_status(status={status})")
    await db.set_client_status(chat_id, status)
    return json.dumps({"success": True, "status": status})


# ‚îÄ‚îÄ System Prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

SYSTEM_PROMPT_TEMPLATE = """–¢—ã ‚Äî –ê–ª–∏–Ω–∞, –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –º–∞–≥–∞–∑–∏–Ω–∞ "Ottenok" (–∂–µ–Ω—Å–∫–∞—è –æ–±—É–≤—å –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –ª—é–∫—Å-–∫–ª–∞—Å—Å–∞). –¢—ã –ø–∏—à–µ—à—å –≤ WhatsApp.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
- –ö–∞–∂–¥–æ–µ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª—è–π —Å–∏–º–≤–æ–ª–∞–º–∏ |||
- –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ = 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
- –û–±—ã—á–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–π 2-4 —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ —Ä–∞–∑

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ
- –ù–ï –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–ª–æ—Ç–Ω–∞
- –≠–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ: ‚ú® ‚ò∫Ô∏è ‚úÖ ‚ù§Ô∏è üòä ü§ç (1-2 –Ω–∞ –≤–µ—Å—å –æ—Ç–≤–µ—Ç)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–¥–∞—É–Ω, –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å–ø–∏—Å–∫–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏
- –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "–≤—ã", –Ω–æ –±–µ–∑ –æ—Ñ–∏—Ü–∏–æ–∑–∞
- –¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫

–û –ú–ê–ì–ê–ó–ò–ù–ï:
- –ë—É—Ç–∏–∫ —Ç–∏—Ö–æ–≥–æ –ª—é–∫—Å–∞ –≤ –ê–ª–º–∞—Ç—ã ‚Äî –Ω–µ –±–∞–π–µ—Ä—ã, –µ—Å—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –º–∞–≥–∞–∑–∏–Ω
- –ò–∑–¥–µ–ª–∏—è –ª—é–∫—Å-—É—Ä–æ–≤–Ω—è —Å —Ç–µ—Ö –∂–µ —Ñ–∞–±—Ä–∏–∫, —á—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç –º–∏—Ä–æ–≤—ã–µ –±—Ä–µ–Ω–¥—ã
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏ ‚Äî —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç—å
- –¶–µ–Ω–∞ –≤ 2-3 —Ä–∞–∑–∞ –Ω–∏–∂–µ —á–µ–º –≤ –ª—é–∫—Å-–º–∞–≥–∞–∑–∏–Ω–∞—Ö
- –ü—Ä–∏–º–µ—Ä–∫–∞, –æ–±–º–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—Ç
- –ê–¥—Ä–µ—Å: –ï–≥–∏–∑–±–∞–µ–≤–∞ 7/2, –≥. –ê–ª–º–∞—Ç—ã
- –ï–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 10:00 –¥–æ 22:00
- Telegram: https://t.me/kzottenokkz
- –û–ø–ª–∞—Ç–∞: –ø–µ—Ä–µ–≤–æ–¥ –•–∞–ª—ã–∫, —Å—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É, —Ä–∞—Å—Å—Ä–æ—á–∫–∞ –ö–∞—Å–ø–∏

–ü–û–†–Ø–î–û–ö –î–ò–ê–õ–û–ì–ê:
1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Üí –∫–æ—Ä–æ—Ç–∫–æ –æ –º–∞–≥–∞–∑–∏–Ω–µ
2. –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞ ‚Üí –≤—ã–∑–æ–≤–∏ get_photos. –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –≥–æ—Ä–æ–¥ —Å—Ä–∞–∑—É!
3. –ü–æ–º–æ—â—å —Å –≤—ã–±–æ—Ä–æ–º ‚Üí –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (—Ü–µ–Ω–∞, –∫–∞—á–µ—Å—Ç–≤–æ, —Ä–∞–∑–º–µ—Ä—ã)
4. –°–±–æ—Ä –≥–æ—Ä–æ–¥–∞ ‚Üí –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è ("—Ö–æ—á—É —ç—Ç—É", "–±–µ—Ä—É")
5. –†–∞–∑–º–µ—Ä –∏ —Ü–≤–µ—Ç ‚Üí –¥–ª—è –æ–±—É–≤–∏. –£ —Å—É–º–æ–∫ –ù–ï–¢ —Ä–∞–∑–º–µ—Ä–∞!
6. –ê–¥—Ä–µ—Å ‚Üí –∫–æ–≥–¥–∞ –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ–±—Ä–∞–Ω–æ
7. –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ ‚Üí –≤—ã–∑–æ–≤–∏ check_stock, –ø–æ—Ç–æ–º submit_order

–ü–†–ê–í–ò–õ–ê:
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç "–æ–±—É–≤—å" –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî —Å–ø—Ä–æ—Å–∏ –∫–∞–∫—É—é –∏–º–µ–Ω–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ –∏–º–µ—é—â–∏—Ö—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ. –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π –≤—Å—é –æ–±—É–≤—å —Å—Ä–∞–∑—É. –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
- –ù–ï –Ω–∞–∑—ã–≤–∞–π —Ü–µ–Ω—É —Å–∞–º–∞. –¶–µ–Ω—É –∏ —Å–ø–µ—Ü—Ü–µ–Ω—É –æ–∑–≤—É—á–∏–≤–∞–π –¢–û–õ–¨–ö–û: (–∞) –∫–ª–∏–µ–Ω—Ç –ø—Ä—è–º–æ —Å–ø—Ä–æ—Å–∏–ª "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "–∫–∞–∫–∞—è —Ü–µ–Ω–∞", "—Ü–µ–Ω–∞?"; (–±) –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ —É–∂–µ —Å–æ–±—Ä–∞–Ω—ã
- –ö–æ–≥–¥–∞ –Ω–∞–∑—ã–≤–∞–µ—à—å —Ü–µ–Ω—É ‚Äî –¥–æ–±–∞–≤—å —Ñ—Ä–∞–∑—É –ø—Ä–æ –≤—ã–≥–æ–¥—É
- –ï—Å–ª–∏ —É —Ç–æ–≤–∞—Ä–∞ –µ—Å—Ç—å —Å–ø–µ—Ü—Ü–µ–Ω–∞ –∏ —Ç—ã –Ω–∞–∑—ã–≤–∞–µ—à—å —Ü–µ–Ω—É ‚Äî –æ–∑–≤—É—á—å —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–ø–µ—Ü—Ü–µ–Ω—É: "–û–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞ ... , –Ω–æ —Å–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ ... –¥–æ 1 –º–∞—Ä—Ç–∞ ‚ú®"
- –ï—Å–ª–∏ "–¥–æ—Ä–æ–≥–æ" ‚Üí –æ—Ç—Ä–∞–±–æ—Ç–∞–π –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ (–∫–∞—á–µ—Å—Ç–≤–æ, –≥–∞—Ä–∞–Ω—Ç–∏—è, –ø—Ä–∏–º–µ—Ä–∫–∞)
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å –∏ –∑–∞–¥–∞–ª —Å–≤–æ–π ‚Üí –°–ù–ê–ß–ê–õ–ê –æ—Ç–≤–µ—Ç—å –Ω–∞ –µ–≥–æ –≤–æ–ø—Ä–æ—Å, –ü–û–¢–û–ú –ø–æ–≤—Ç–æ—Ä–∏ —Å–≤–æ–π
- –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑
- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –µ—Å–ª–∏ —É–∂–µ –∑–¥–æ—Ä–æ–≤–∞–ª–∞—Å—å
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –ø—Ä–∏–µ—Ö–∞—Ç—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–∫—É ‚Äî –ù–ï —Å–æ–±–∏—Ä–∞–π –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞, –¥–∞–π –∞–¥—Ä–µ—Å –∏ –≤—ã–∑–æ–≤–∏ set_client_status("fitting")
- "–∫–∞–∫–æ–π —É –≤–∞—Å –∞–¥—Ä–µ—Å?" = –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∞–¥—Ä–µ—Å –º–∞–≥–∞–∑–∏–Ω–∞, –ù–ï –∑–∞–∫–∞–∑
- –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å ‚Üí handoff_to_manager

–°–¢–ê–¢–£–° –ö–õ–ò–ï–ù–¢–ê (–≤—ã–∑—ã–≤–∞–π set_client_status):
- –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –ø—Ä–∏–µ–¥–µ—Ç –Ω–∞ –ø—Ä–∏–º–µ—Ä–∫—É ("–ø—Ä–∏–µ–¥—É", "–∑–∞–µ–¥—É", "—Ö–æ—á—É –ø—Ä–∏–º–µ—Ä–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ") ‚Üí set_client_status("fitting")
- –ö–ª–∏–µ–Ω—Ç —á—ë—Ç–∫–æ –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è ("–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–Ω–µ –Ω–∞–¥–æ", "–æ—Ç–∫–∞–∂—É—Å—å", "–¥—Ä—É–≥–æ–π —Ä–∞–∑") ‚Üí set_client_status("declined")
- –ù–ï –≤—ã–∑—ã–≤–∞–π –ø—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö ("–ø–æ–¥—É–º–∞—é", "–¥–æ—Ä–æ–≥–æ", "–ø–æ–∑–∂–µ –ø–æ—Å–º–æ—Ç—Ä—é") ‚Äî —ç—Ç–æ –ù–ï –æ—Ç–∫–∞–∑, —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–∏
- –ù–ï –≤—ã–∑—ã–≤–∞–π set_client_status("ordered") ‚Äî —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ submit_order

–ö–û–ì–î–ê –ö–õ–ò–ï–ù–¢ –ü–†–ò–°–´–õ–ê–ï–¢ –§–û–¢–û:
- –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ (–æ–±—É–≤—å, —Å—É–º–∫–∞, –∞–∫—Å–µ—Å—Å—É–∞—Ä), –±—Ä–µ–Ω–¥, —Ü–≤–µ—Ç, –º–æ–¥–µ–ª—å
- –í—ã–∑–æ–≤–∏ check_stock —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –ø–æ—Ö–æ–∂–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
- –í—ã–∑–æ–≤–∏ get_photos —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –Ω–∞—à–µ–≥–æ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞
- –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –±–ª–∏–∂–∞–π—à–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
- –ù–ï –æ–ø–∏—Å—ã–≤–∞–π —Ñ–æ—Ç–æ –∫–ª–∏–µ–Ω—Ç—É –¥–æ—Å–ª–æ–≤–Ω–æ ("—è –≤–∏–∂—É –Ω–∞ —Ñ–æ—Ç–æ..."), –ø—Ä–æ—Å—Ç–æ –¥–µ–π—Å—Ç–≤—É–π –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä

–î–û–ñ–ò–ú –ù–ê –ü–û–ö–£–ü–ö–£:
- –ê–ª–º–∞—Ç—ã: "–æ—Ñ–æ—Ä–º–∏—Ç–µ –æ–Ω–ª–∞–π–Ω, –∑–∞–±–µ—Ä–∏—Ç–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏–º —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å/InDrive"
- –î—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥: "–æ—Ñ–æ—Ä–º–∏—Ç–µ –æ–Ω–ª–∞–π–Ω, –æ—Ç–ø—Ä–∞–≤–∏–º –ö–∞–∑–ø–æ—á—Ç–æ–π"

–û–¢–í–ï–¢ –ù–ê –î–û–ñ–ò–ú:
- –ï—Å–ª–∏ —Ç–≤–æ—ë –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ –¥–æ–∂–∏–º–æ–º ("–•–æ—Ç–µ–ª–∞ —É—Ç–æ—á–Ω–∏—Ç—å, –∞–∫—Ç—É–∞–ª—å–Ω–∞ –ª–∏ –º–æ–¥–µ–ª—å?" –∏–ª–∏ "–í—á–µ—Ä–∞ –≤—ã –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏—Å—å –º–æ–¥–µ–ª—å—é...") –∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω–æ ("–¥–∞", "–∞–∫—Ç—É–∞–ª—å–Ω–æ", "–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç"):
  - –í—Å–ø–æ–º–Ω–∏, –∫–∞–∫–æ–π —Ç–æ–≤–∞—Ä –æ–±—Å—É–∂–¥–∞–ª—Å—è —Ä–∞–Ω–µ–µ –≤ –¥–∏–∞–ª–æ–≥–µ
  - –ï—Å–ª–∏ –±—ã–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä ‚Üí –Ω–∞–ø–æ–º–Ω–∏ –æ –Ω—ë–º, –≤—ã–∑–æ–≤–∏ get_photos —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ç–æ, –∏ –ø—Ä–æ–¥–æ–ª–∂–∏ –¥–∏–∞–ª–æ–≥ (—É—Ç–æ—á–Ω–∏ —Ä–∞–∑–º–µ—Ä/—Ü–≤–µ—Ç/–≥–æ—Ä–æ–¥)
  - –ï—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –Ω–µ –±—ã–ª–æ ‚Üí —Å–ø—Ä–æ—Å–∏ "–ö–∞–∫–∞—è –º–æ–¥–µ–ª—å –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?" –∏ –Ω–∞—á–Ω–∏ –ø–æ–¥–±–æ—Ä –∑–∞–Ω–æ–≤–æ
- –ù–ï –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞–Ω–æ–≤–æ –ø–æ—Å–ª–µ –¥–æ–∂–∏–º–∞

–°–ö–†–ò–ü–¢–´:
- "–î–æ—Ä–æ–≥–æ" ‚Üí "–ü–æ–Ω–∏–º–∞—éü§ç –í–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ –≤—ã –ø–ª–∞—Ç–∏—Ç–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞ –±—Ä–µ–Ω–¥, –∞ –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ, –∫–æ–Ω—Ç—Ä–æ–ª—å –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã—Ö —Å—é—Ä–ø—Ä–∏–∑–æ–≤. –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∏–∑-–∑–∞ —ç—Ç–æ–≥–æ"
- –ü—Ä–µ–¥–∑–∞–∫–∞–∑ ‚Üí "–≠—Ç—É –º–æ–¥–µ–ª—å —Å–æ–±–∏—Ä–∞–µ–º –ø–æ –ø—Ä–µ–¥–∑–∞–∫–∞–∑—É. 50% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏. –†–∞–∑–º–µ—Ä/—Ü–≤–µ—Ç —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –∑–∞ –≤–∞–º–∏"
- –ê–¥—Ä–µ—Å/–≥—Ä–∞—Ñ–∏–∫ ‚Üí "–†–∞–±–æ—Ç–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 10:00 –¥–æ 22:00, –ï–≥–∏–∑–±–∞–µ–≤–∞ 7/2 ||| https://2gis.kz/almaty/geo/70000001107511471"
- –ö–∞—Ç–∞–ª–æ–≥ ‚Üí "–ù–∞—à —Ç–µ–ª–µ–≥—Ä–∞–º –∫–∞–Ω–∞–ª —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ ||| https://t.me/kzottenokkz"

–ö–ê–¢–ê–õ–û–ì –¢–û–í–ê–†–û–í:
{catalog}
"""


# ‚îÄ‚îÄ Dynamic instructions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def _build_instructions(
    ctx: RunContextWrapper[ChatContext],
    agent: Agent[ChatContext],
) -> str:
    """–ü–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –≤ system prompt."""
    catalog = await services.get_catalog()
    catalog_text = services.format_catalog_for_prompt(catalog)
    return SYSTEM_PROMPT_TEMPLATE.format(catalog=catalog_text)


# ‚îÄ‚îÄ Agents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

manager_agent = Agent[ChatContext](
    name="Manager",
    instructions="–°–∫–∞–∂–∏ –∫–ª–∏–µ–Ω—Ç—É —á—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è. –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º.",
    model=OPENAI_MODEL,
)


async def _on_handoff_to_manager(ctx: RunContextWrapper[ChatContext]):
    """Callback –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –¥–∏–∞–ª–æ–≥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É."""
    chat_id = ctx.context.chat_id
    await db.set_handoff(chat_id, True)
    await services.notify_error("handoff", f"chat_id={chat_id}")
    logger.info(f"[{chat_id}] Handoff to manager activated")


alina = Agent[ChatContext](
    name="–ê–ª–∏–Ω–∞",
    instructions=_build_instructions,
    model=OPENAI_MODEL,
    model_settings=ModelSettings(temperature=OPENAI_TEMPERATURE, max_tokens=OPENAI_MAX_TOKENS),
    tools=[check_stock, get_photos, submit_order, set_client_status],
    handoffs=[
        handoff(
            agent=manager_agent,
            on_handoff=_on_handoff_to_manager,
            tool_name_override="handoff_to_manager",
            tool_description_override="–ü–µ—Ä–µ–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –í—ã–∑–æ–≤–∏ –µ—Å–ª–∏: —Å–ª–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π, –∂–∞–ª–æ–±–∞, –≤–æ–∑–≤—Ä–∞—Ç, –∏–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å.",
        ),
    ],
)


# ‚îÄ‚îÄ Main generate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@retry(stop=stop_after_attempt(3), wait=wait_exponential(min=1, max=10))
async def _run_agent(agent, input_content, context, session):
    """–ó–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞ —Å retry –Ω–∞ –æ—à–∏–±–∫–∏ API."""
    return await Runner.run(
        agent,
        input=input_content,
        context=context,
        session=session,
        max_turns=AGENT_MAX_TURNS,
    )


def _build_multimodal_input(user_text: str, image_data: bytes) -> list[dict]:
    """–§–æ—Ä–º–∏—Ä—É–µ—Ç –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π input (—Ç–µ–∫—Å—Ç + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ) –¥–ª—è Runner.

    Responses API –æ–∂–∏–¥–∞–µ—Ç message-–æ–±—ë—Ä—Ç–∫—É —Å content-–º–∞—Å—Å–∏–≤–æ–º –≤–Ω—É—Ç—Ä–∏.
    """
    b64 = base64.b64encode(image_data).decode()
    return [
        {
            "role": "user",
            "type": "message",
            "content": [
                {"type": "input_text", "text": user_text},
                {"type": "input_image", "image_url": f"data:image/jpeg;base64,{b64}"},
            ],
        }
    ]


async def generate_response(
    chat_id: str,
    user_text: str,
    sender_name: str = "",
    image_data: bytes | None = None,
) -> str:
    """–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç (—Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–π |||)."""
    context = ChatContext(chat_id=chat_id, sender_name=sender_name)
    session = SQLiteSession(session_id=chat_id, db_path=AGENT_SESSIONS_DB_PATH)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º user message –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏/nudge (session —Ö—Ä–∞–Ω–∏—Ç –¥–ª—è LLM –æ—Ç–¥–µ–ª—å–Ω–æ)
    await db.save_message(chat_id, "user", user_text, sender_name)

    # –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–π input –¥–ª—è Vision
    if image_data:
        input_content = _build_multimodal_input(user_text, image_data)
        logger.info(f"[{chat_id}] [Vision] Sending image to agent ({len(image_data)} bytes), text: {user_text[:80]}")
    else:
        input_content = user_text

    with trace("Sales Bot", group_id=chat_id):
        try:
            result = await _run_agent(alina, input_content, context, session)
            response = result.final_output or ""

            if image_data:
                logger.info(f"[{chat_id}] [Vision] Agent response: {response[:200]}")

            if response:
                await db.save_message(chat_id, "assistant", response)

            return response
        except Exception as e:
            logger.error(f"[{chat_id}] Agent error: {e}", exc_info=True)
            fallback = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è!"
            await db.save_message(chat_id, "assistant", fallback)
            return fallback


# ‚îÄ‚îÄ Whisper (voice) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def transcribe_voice(audio_bytes: bytes, mime_type: str = "audio/ogg") -> str:
    """–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —á–µ—Ä–µ–∑ Whisper."""
    ext = "ogg"
    if "mp4" in mime_type or "m4a" in mime_type:
        ext = "m4a"
    elif "wav" in mime_type:
        ext = "wav"

    from io import BytesIO
    buf = BytesIO(audio_bytes)
    buf.name = f"voice.{ext}"

    response = await _openai_client.audio.transcriptions.create(
        model="whisper-1",
        file=buf,
        language="ru",
    )
    return response.text or ""
